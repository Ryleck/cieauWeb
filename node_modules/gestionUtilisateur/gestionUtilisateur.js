/**
 * Created by Phil on 2015-04-02.
 */
var fs = require('fs');
var xml2js = require('xml2js');
var parser = new xml2js.Parser();
var tableauUtilisateurs = [];

module.exports = {
    ajouterUtilisateur:function(nom, motDePasse, courriel){
        var utilisateur = {
            varNom:nom,
            varMotDePasse:motDePasse,
            varCourriel:courriel
        };
        //console.log(utilisateur);
        tableauUtilisateurs = LireFichier();
        tableauUtilisateurs.push(utilisateur);
        EcrireFichier(tableauUtilisateurs);
        console.log(tableauUtilisateurs);
    },
    supprimerUtilisateur:function(nom){
        var l = tableauUtilisateurs.length;
        for(var i = 0; i < l; i++){
            if(tableauUtilisateurs[i].varNom == nom){
                tableauUtilisateurs.splice(i,1);
                i = l;
            }
        }
        EcrireFichier(tableauUtilisateurs);
    },
    bonMDP:function(nom, motDePasse){
        var l = tableauUtilisateurs.length;
        //console.log(nom+' '+motDePasse);
        for(var i = 0; i < l; i++){
            if((tableauUtilisateurs[i].varNom == nom)&&(tableauUtilisateurs[i].varMotDePasse == motDePasse)){
                return 1;
            }
        }
        return 0;
    },
    retournerMDP:function(courriel){
        var l = tableauUtilisateurs.length;
        for(var i = 0; i < l; i++){
            if(tableauUtilisateurs[i].varCourriel == courriel){
                return tableauUtilisateurs[i].varMotDePasse;
            }
        }
        return -1;
    },
    retournerUtilisateur:function(courriel){
        var l = tableauUtilisateurs.length;
        for(var i = 0; i < l; i++){
            if(tableauUtilisateurs[i].varCourriel == courriel){
                return tableauUtilisateurs[i].varNom;
            }
        }
        return -1;
    },
    utilisateurExiste:function(nom){
        var l = tableauUtilisateurs.length;
        for(var i = 0; i < l; i++){
            if(tableauUtilisateurs[i].varNom == nom){
                return 1;
            }
        }
        return 0;
    },
    chargerFichier:function(){
        tableauUtilisateurs = LireFichier();
        console.log(tableauUtilisateurs);
    }
};


function EcrireFichier(tUtilisateur){
    var fileName = 'files/utilisateurs.xml';
    var sXML = '';
    try {
        fs.mkdirSync('files');
    } catch(e) {
        if ( e.code != 'EEXIST' ) throw e;
    }
    sXML = '<utilisateurs>';
    for(var i = 0; i < tUtilisateur.length; i++){
        sXML += '<utilisateur><nom>'+tUtilisateur[i].varNom+'</nom>';
        sXML += '<mdp>'+tUtilisateur[i].varMotDePasse+'</mdp>';
        sXML += '<courriel>'+tUtilisateur[i].varCourriel+'</courriel></utilisateur>';
    }
    sXML += '</utilisateurs>';
    fs.writeFileSync(fileName, sXML);
};

function LireFichier(){
    var fileName = 'files/utilisateurs.xml';
    var data = fs.readFileSync(fileName);
    var utilisateurs = [];
    parser.parseString(data, function (err, result) {
        if(result.utilisateurs.utilisateur) {
            for (var i = 0; i < result.utilisateurs.utilisateur.length; i++) {
                utilisateurs.push({
                    varNom: result.utilisateurs.utilisateur[i].nom,
                    varMotDePasse: result.utilisateurs.utilisateur[i].mdp,
                    varCourriel: result.utilisateurs.utilisateur[i].courriel
                });
            }
        }
    });
    return utilisateurs;
};