/**
 * Created by Phil on 2014-12-23.
 */
var fs = require('fs');
var xml2js = require('xml2js');
var parser = new xml2js.Parser();

module.exports = {
    listeFichiersHTML: function(utilisateur, index){
        var liste;
        var fichiers = '';
        var strID = 'dListeFichier1';
        var dis = 'disabled';
        if (utilisateur == 'admin'){
            dis = '';
        }
        //console.log(utilisateur);
        if ((utilisateur == '') || (utilisateur == 'aucune')){
            utilisateur = 'default';
        }
        if (utilisateur != 'admin') {
            try {
                liste = fs.readdirSync('files/' + utilisateur + '/');
                //console.log(fichiers);
                fichiers = fichiers + '<div id="separateur" class="dListeFichierSep">Pr&eacute;sentations</div>'
                for (i = 0; i < liste.length; i++) {
                    var fileName = liste[i].substring(0, liste[i].lastIndexOf('.'));
                    fichiers = fichiers + '<div id="dFichiers" name="' + fileName + '"';
                    fichiers = fichiers + 'class=' + strID;
                    fichiers = fichiers + '><label>' + fileName + etatFichier (utilisateur, fileName) + '</label>';
                    fichiers = fichiers + telecharge(utilisateur, index, fileName);
                    fichiers = fichiers + '<button type="button" id="iButtonDelete" name="' + fileName + '"> Supprimer </button>';
                    fichiers = fichiers + '<form id="formFichier" action="/info" method="post">'
                    fichiers = fichiers + '<input type="hidden" name="index" value="' + index + '">';
                    fichiers = fichiers + '<input type="hidden" name="utilisateur" value="' + utilisateur + '">';
                    fichiers = fichiers + '<input type="hidden" name="fichier" value="' + fileName + '">';
                    fichiers = fichiers + '<input id="iButtonMod" name="action" type="submit" value="Modifier">';
                    fichiers = fichiers + '</form><form id="formFichier" action="/presentationIntro" method="post" target="_blank">'
                    fichiers = fichiers + '<input type="hidden" name="index" value="' + index + '">';
                    fichiers = fichiers + '<input type="hidden" name="utilisateur" value="' + utilisateur + '">';
                    fichiers = fichiers + '<input type="hidden" name="fichier" value="' + fileName + '">';
                    fichiers = fichiers + '<input id="iButtonLoad" type="submit" value="Charger"></form>';
                    fichiers = fichiers + '<button id="buttonInfo" type="button" value="'+ fileName +'" style="float: right">Aperçu</button></div>';
                    if (strID == 'dListeFichier1') {
                        strID = 'dListeFichier2';
                    } else {
                        strID = 'dListeFichier1';
                    }
                }

            } catch (e) {
            }
        }else{
            fileName = 'utilisateurs';
            fichiers = fichiers + '<div id="dFichiers" name="' + fileName + '"';
            fichiers = fichiers + 'class=dListeFichier3';
            fichiers = fichiers + '><label>' + fileName + '</label>';
            fichiers = fichiers + telecharge(utilisateur, index, fileName);
            fichiers = fichiers + '<form id="formFichier" action="/gererUtilisateur" method="post" target="_blank">'
            fichiers = fichiers + '<input type="hidden" name="index" value="' + index + '">';
            fichiers = fichiers + '<input type="hidden" name="utilisateur" value="admin">';
            fichiers = fichiers + '<input type="hidden" name="fichier" value="' + fileName + '">';
            fichiers = fichiers + '<input id="iButtonMod" name="action" type="submit" value="Gérer">';
            fichiers = fichiers + '</div>';
        }
        try {
            liste = fs.readdirSync('files/admin/');
            //console.log(fichiers);
            fichiers = fichiers + '<div id="separateur" class="dListeFichierSep">Mod&egrave;les</div>'
            for (i = 0; i < liste.length; i++) {
                fileName = liste[i].substring(0, liste[i].lastIndexOf('.'));
                fichiers = fichiers + '<div id="dFichiers" name="' + fileName + '"';
                fichiers = fichiers + 'class=' + strID;
                fichiers = fichiers + '><label>' + fileName + etatFichier ("admin", fileName) +'</label>';
                fichiers = fichiers + telecharge(utilisateur, index, fileName);
                fichiers = fichiers + '<button type="button" id="iButtonDelete" name="' + fileName + '" '+ dis +'> Supprimer </button>';
                fichiers = fichiers + '<form id="formFichier" action="/info" method="post">'
                fichiers = fichiers + '<input type="hidden" name="index" value="' + index + '">';
                fichiers = fichiers + '<input type="hidden" name="utilisateur" value="admin">';
                fichiers = fichiers + '<input type="hidden" name="fichier" value="' + fileName + '">';
                fichiers = fichiers + '<input id="iButtonMod" name="action" type="submit" value="Modifier">';
                fichiers = fichiers + '</form><form id="formFichier" action="/presentationIntro" method="post" target="_blank">'
                fichiers = fichiers + '<input type="hidden" name="index" value="' + index + '">';
                fichiers = fichiers + '<input type="hidden" name="utilisateur" value="admin">';
                fichiers = fichiers + '<input type="hidden" name="fichier" value="' + fileName + '">';
                fichiers = fichiers + '<input id="iButtonLoad" type="submit" value="Charger"></form>';
                fichiers = fichiers + '<button id="buttonInfoAdmin" type="button" value="'+ fileName +'" style="float: right">Aperçu</button></div>';
                if (strID == 'dListeFichier1') {
                    strID = 'dListeFichier2';
                } else {
                    strID = 'dListeFichier1';
                }
            }

        }catch(e){}
        return fichiers;
    }
};

function telecharge(user, index, fileName){
    var s = '';
    if(user == 'admin'){
        s = '</form><form id="formFichier" action="/getFichier" method="post" target="_blank">';
        s = s + '<input type="hidden" name="index" value="' + index + '">';
        s = s + '<input type="hidden" name="utilisateur" value="admin">';
        s = s + '<input type="hidden" name="fichier" value="' + fileName + '">';
        s = s + '<input type="submit" value="Télécharger"></form>';
    }else{
        s = '<!-- </form><form id="formFichier" action="/getFichier" method="post" target="_blank">';
        s = s + '<input type="hidden" name="index" value="' + index + '">';
        s = s + '<input type="hidden" name="utilisateur" value="'+user+'">';
        s = s + '<input type="hidden" name="fichier" value="' + fileName + '">';
        s = s + '<input type="submit" value="Télécharger"></form> -->';
    }
    return s;
}

function etatFichier (utilisateur, fileName){
    var path = 'files/' + utilisateur + '/' + fileName + '.xml';
    var data = fs.readFileSync(path);
    var etatFichier;
    parser.parseString(data, function (err, result) {
        //console.log(result);
        //console.log(err);
        if(result.presentation.etat[0] == "complete"){
            etatFichier = "";
        }else if (result.presentation.etat[0] == "modifie"){
            etatFichier = " *";
        }else{
            etatFichier = " **";
        }
    });
    return etatFichier;
}